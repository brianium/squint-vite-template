{:deps
 {org.babashka/json {:mvn/version "0.1.6"}}
 
 :tasks
 {:requires ([babashka.json :as json]
             [clojure.string :as str])
  
  dev:squint (shell "npx squint watch --repl true")
  dev:vite   (shell "npx vite")
  -dev {:depends [dev:squint dev:vite]}
  dev (run '-dev {:parallel true})

  build:squint (shell "npx squint compile")
  build:vite   (shell "npx vite build")
  
  update-html {:doc "Update index.html with hashed filenames from Vite manifest"
               :task (let [manifest (json/read-str (slurp "dist/.vite/manifest.json") {:key-fn identity})
                           html (slurp "index.html")
                           updated-html (reduce (fn [html-content [key entry]]
                                                 (let [src-path (get entry "src")
                                                       file-path (get entry "file")]
                                                   (if (and src-path file-path (get entry "isEntry"))
                                                     (-> html-content
                                                         ;; Replace exact path
                                                         (str/replace (str "\"" src-path "\"") (str "\"" file-path "\""))
                                                         ;; Replace path with leading slash
                                                         (str/replace (str "\"/" src-path "\"") (str "\"/" file-path "\"")))
                                                     html-content)))
                                               html
                                               manifest)]
                       ;; Copy index.html to dist directory
                       (spit "dist/index.html" updated-html) 
                       (println "âœ“ Updated index.html with manifest paths and copied to dist/"))}
  
  build {:depends [build:squint build:vite update-html]}}}
